<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js lfe-pdp">

<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>Complex Interactions - Casting SPELs in LFE</title>
    
    


    <!-- Custom HTML head -->
    


    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="The LFE Edition of the Classic Lisp Comic Book">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff" />

    <link rel="icon" href="../favicon.svg">
    <link rel="shortcut icon" href="../favicon.png">
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/general.css">
    <link rel="stylesheet" href="../css/chrome.css">
    <link rel="stylesheet" href="../css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
    
    <link rel="stylesheet" href="../fonts/fonts.css">
    

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="../highlight.css">
    <link rel="stylesheet" href="../tomorrow-night.css">
    <link rel="stylesheet" href="../ayu-highlight.css">

    <!-- Custom theme stylesheets -->
    
    <link rel="stylesheet" href="../css/custom.css">
    

    
</head>

<body>
    <!-- Provide site root to javascript -->
    <script type="text/javascript">
        var path_to_root = "../";
        var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "lfe-pdp" : "lfe-pdp";
    </script>

    <!-- Work around some values being stored in localStorage wrapped in quotes -->
    <script type="text/javascript">
        try {
            var theme = localStorage.getItem('mdbook-theme');
            var sidebar = localStorage.getItem('mdbook-sidebar');

            if (theme.startsWith('"') && theme.endsWith('"')) {
                localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
            }

            if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
            }
        } catch (e) { }
    </script>

    <!-- Set the theme before any content is loaded, prevents flash -->
    <script type="text/javascript">
        var theme;
        try { theme = localStorage.getItem('mdbook-theme'); } catch (e) { }
        if (theme === null || theme === undefined) { theme = default_theme; }
        var html = document.querySelector('html');
        html.classList.remove('no-js')
        html.classList.remove('lfe-pdp')
        html.classList.add(theme);
        html.classList.add('js');
    </script>

    <!-- Hide / unhide sidebar before it is displayed -->
    <script type="text/javascript">
        var html = document.querySelector('html');
        var sidebar = 'hidden';
        if (document.body.clientWidth >= 1080) {
            try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch (e) { }
            sidebar = sidebar || 'visible';
        }
        html.classList.remove('sidebar-visible');
        html.classList.add("sidebar-" + sidebar);
    </script>

    <nav id="sidebar" class="sidebar" aria-label="Table of contents">
        <div class="sidebar-scrollbox">
            <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Casting SPELs in LFE</a></li><li class="chapter-item expanded "><a href="../front-matter/copyright-page.html"><strong aria-hidden="true">2.</strong> Copyright Page</a></li><li class="chapter-item expanded "><a href="../introduction/index.html"><strong aria-hidden="true">3.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../part1/index.html"><strong aria-hidden="true">4.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part1/1-setup.html"><strong aria-hidden="true">4.1.</strong> Getting Set Up</a></li><li class="chapter-item expanded "><a href="../part1/2-synsem.html"><strong aria-hidden="true">4.2.</strong> Syntax and Semantics</a></li></ol></li><li class="chapter-item expanded "><a href="../part2/index.html"><strong aria-hidden="true">5.</strong> Introducing the Game</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part2/1-lay.html"><strong aria-hidden="true">5.1.</strong> Lay of the Land</a></li><li class="chapter-item expanded "><a href="../part2/2-funcs.html"><strong aria-hidden="true">5.2.</strong> Introducing Functions</a></li></ol></li><li class="chapter-item expanded "><a href="../part3/index.html"><strong aria-hidden="true">6.</strong> Getting Functional</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part3/1-glob.html"><strong aria-hidden="true">6.1.</strong> Global State</a></li><li class="chapter-item expanded "><a href="../part3/2-nonglob.html"><strong aria-hidden="true">6.2.</strong> A Non-global Alternative</a></li><li class="chapter-item expanded "><a href="../part3/3-fp.html"><strong aria-hidden="true">6.3.</strong> The Functional Programming Style</a></li></ol></li><li class="chapter-item expanded "><a href="../part4/index.html"><strong aria-hidden="true">7.</strong> Game World Data</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part4/1-records.html"><strong aria-hidden="true">7.1.</strong> Organizing Things with Records</a></li><li class="chapter-item expanded "><a href="../part4/2-map.html"><strong aria-hidden="true">7.2.</strong> Making the Game State</a></li><li class="chapter-item expanded "><a href="../part4/3-recfuncs.html"><strong aria-hidden="true">7.3.</strong> Records Functions</a></li></ol></li><li class="chapter-item expanded "><a href="../part5/index.html"><strong aria-hidden="true">8.</strong> Looking Around in our Game World</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part5/1-location.html"><strong aria-hidden="true">8.1.</strong> Location, Location, Location</a></li><li class="chapter-item expanded "><a href="../part5/2-patts.html"><strong aria-hidden="true">8.2.</strong> Thinking in Patterns</a></li><li class="chapter-item expanded "><a href="../part5/3-exits.html"><strong aria-hidden="true">8.3.</strong> Exits</a></li><li class="chapter-item expanded "><a href="../part5/4-finding.html"><strong aria-hidden="true">8.4.</strong> Finding Things</a></li><li class="chapter-item expanded "><a href="../part5/5-looking.html"><strong aria-hidden="true">8.5.</strong> Putting These Pieces Together</a></li></ol></li><li class="chapter-item expanded "><a href="../part6/index.html"><strong aria-hidden="true">9.</strong> Casting SPELs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part6/1-walking.html"><strong aria-hidden="true">9.1.</strong> Walking Around In Our World</a></li><li class="chapter-item expanded "><a href="../part6/2-spels.html"><strong aria-hidden="true">9.2.</strong> Introducing SPELs</a></li><li class="chapter-item expanded "><a href="../part6/3-interact.html"><strong aria-hidden="true">9.3.</strong> Interacting</a></li><li class="chapter-item expanded "><a href="../part6/4-cmplx.html" class="active"><strong aria-hidden="true">9.4.</strong> Complex Interactions</a></li><li class="chapter-item expanded "><a href="../part6/5-spacts.html"><strong aria-hidden="true">9.5.</strong> Creating Special Actions</a></li><li class="chapter-item expanded "><a href="../part6/6-winact.html"><strong aria-hidden="true">9.6.</strong> The Winning Move</a></li></ol></li><li class="chapter-item expanded "><a href="../part7/index.html"><strong aria-hidden="true">10.</strong> Adding a Simple Game Server</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part7/1-state.html"><strong aria-hidden="true">10.1.</strong> The Problem of State</a></li><li class="chapter-item expanded "><a href="../part7/2-closures.html"><strong aria-hidden="true">10.2.</strong> A Glance at Closures</a></li><li class="chapter-item expanded "><a href="../part7/3-processes.html"><strong aria-hidden="true">10.3.</strong> Light-weight Processes as Closures</a></li><li class="chapter-item expanded "><a href="../part7/4-server.html"><strong aria-hidden="true">10.4.</strong> Making a Game Server</a></li><li class="chapter-item expanded "><a href="../part7/5-commands.html"><strong aria-hidden="true">10.5.</strong> Supporting Commands</a></li></ol></li><li class="chapter-item expanded "><a href="../part8/index.html"><strong aria-hidden="true">11.</strong> Let's Play!</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part8/1-win.html"><strong aria-hidden="true">11.1.</strong> Playing to Win</a></li><li class="chapter-item expanded "><a href="../part8/2-lose.html"><strong aria-hidden="true">11.2.</strong> Playing to Lose</a></li><li class="chapter-item expanded "><a href="../part8/3-next.html"><strong aria-hidden="true">11.3.</strong> What's Next?</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../addenda/index.html"><strong aria-hidden="true">12.</strong> Addenda</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../addenda/1-changes.html"><strong aria-hidden="true">12.1.</strong> Changes from the Original</a></li><li class="chapter-item expanded "><a href="../addenda/2-whyspels.html"><strong aria-hidden="true">12.2.</strong> The Case Against the Word &quot;Macro&quot;</a></li><li class="chapter-item expanded "><a href="../addenda/3-otp.html"><strong aria-hidden="true">12.3.</strong> Using OTP</a></li><li class="chapter-item expanded "><a href="../addenda/4-source.html"><strong aria-hidden="true">12.4.</strong> Source Code</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../feedback.html">Feedback</a></li><li class="chapter-item expanded affix "><a href="../redirects/docs.html">LFE Documentation</a></li><li class="chapter-item expanded affix "><a href="../redirects/mdbook.html">Built with mdBook</a></li></ol>
        </div>
        <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
    </nav>

    <div id="page-wrapper" class="page-wrapper">

        <div class="page">
            
            <div id="menu-bar-hover-placeholder"></div>
            <div id="menu-bar" class="menu-bar sticky bordered">
                <div class="left-buttons">
                    <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                        <i class="fa fa-bars"></i>
                    </button>
                    <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                        <i class="fa fa-paint-brush"></i>
                    </button>
                    <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                        <li role="none"><button role="menuitem" class="theme"
                                id="lfe-pdp">LFE PDP</button></li>
                        <li role="none"><button role="menuitem" class="theme"
                                id="light">Light</button></li>
                        <li role="none"><button role="menuitem" class="theme"
                                id="rust">Rust</button></li>
                        <li role="none"><button role="menuitem" class="theme"
                                id="coal">Coal</button></li>
                        <li role="none"><button role="menuitem" class="theme"
                                id="navy">Navy</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button>
                        </li>
                    </ul>
                    
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                        aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                        aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
                    
                </div>

                <h1 class="menu-title">Casting SPELs in LFE</h1>

                <div class="right-buttons">
                    <a href="../print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    
                    <a href="https://github.com/lfe/casting-spels/" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-github"></i>
                    </a>
                    
                </div>
            </div>

            
            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                        placeholder="Search this book ..." aria-controls="searchresults-outer"
                        aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>
            

            <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
            <script type="text/javascript">
                document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                    link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                });
            </script>

            <div id="content" class="content">
                <main>
                    <h2><a class="header" href="#complex-interactions" id="complex-interactions">Complex Interactions</a></h2>
<p>We've just implemented some simple interactions like picking up objects or checking our player's inventory. What about interacting with the world on a conditional basis? We need to add these sorts of actions to the game so that the player can meet the conditions to <em>win</em> in the game.</p>
<p>Now we're to the bit about goals. Let's write some functions that will help us get info about goals and set the status of goals.</p>
<pre><code class="language-lisp">(defun goal-matches?
  ((goal-name (= (match-goal name name) goal)) (when (== goal-name name))
    `#(true ,goal))
  ((_ _)
    'false))

(defun filter-goals (goal-name game-state)
  (lists:filtermap
    (lambda (x) (goal-matches? goal-name x))
    (state-goals state)))

(defun extract-goal
  (('())
    'undefined)
  ((`(,goal))
    goal))

(defun get-goal (goal-name game-state)
  (extract-goal (filter-goals goal-name game-state)))

(defun goal-met? (goal-name game-state)
  (let ((goal (get-goal goal-name game-state)))
    (if (== goal 'undefined)
        goal
        (goal-achieved? goal))))
</code></pre>
<p>There are a couple of things in this code you haven't yet seen:</p>
<ul>
<li>the odd <code>(= ...)</code> form, and</li>
<li><code>lists:filtermap</code></li>
</ul>
<p>The <code>(= ...)</code> form is not an equality test! In LFE, you can test if two things are equal with <code>(== ...)</code> or <code>(=:= ...)</code>. So what is <code>(= ...)</code>, then? If you look at it, you see that it's wrapping a record matching in the function arguments. In our match, we only care about one field from the goal record: <code>name</code>. And we only care if it matches the passed argument <code>goal-name</code>. Let's say our match succeeds, that the chain is already welded ... now what? We don't have any variables defined! Our function needs to return the game state, so how do we get it?</p>
<p>In LFE record-matching, you have the ability to not only match individual fields from a record, but to wrap the whole matching up and assign the passed record to a variable. You do that with the <code>(= ...)</code> form!</p>
<p>The function <code>lists:filtermap</code> does what you might guess: it performs a <code>map</code> and a <code>filter</code> simultaneously. In order to use this, the function passed to <code>lists:filtermap</code> needs to return <code>false</code> for a bad match and a tuple of <code>#(true ,value)</code> for a good match. In our case, the value is the matching goal.</p>
<p>Also, don't let the <code>(goal-acheived? ...)</code> call confuse you -- that's the magically created function for the <code>goal</code> record's <code>achieved?</code> field!</p>
<p>So we've managed to get goal information -- what about updating goals? We can do the same thing that we did for updating objects:</p>
<pre><code class="language-lisp">(defun good-goal (item-name)
  (io:format &quot;~nYou have achieved the '~s' goal!~n&quot;
             (list (atom_to_list item-name))))

(defun check-goal
  ((goal-name (= (match-goal name g-name) goal)) (when (== goal-name g-name))
    (good-goal goal-name)
    (set-goal-achieved? goal 'true))
  ((_ goal) goal))

(defun update-goals (goal-name game-state)
  (set-state-goals
    game-state
    (lists:map
      (lambda (goal) (check-goal goal-name goal))
      (state-goals game-state))))
</code></pre>
<p>The first of the goals we'll write code for is the welding of the chain to the bucket in the attic:</p>
<pre><code class="language-lisp">(defun weld-ready? (game-state)
  (andalso (inv? 'bucket game-state)
           (inv? 'chain game-state)
           (== (state-player-location game-state) 'attic)))
</code></pre>
<p>As you can see, that function checks to make sure that all the necessary conditions are present for a successful welding.</p>
<p>We're going to need some functions that print messages to the player; let's create those now:</p>
<pre><code class="language-lisp">(defun weld-not-ready ()
  (io:format &quot;~nYou seem to be missing a key condition for welding ...~n&quot;))

(defun cant-weld ()
  (io:format &quot;~nYou can't weld like that ...~n&quot;))

(defun good-weld (game-state)
  (io:format &quot;~nThe chain is now securely welded to the bucket.~n&quot;)
  game-state)

(defun already-welded ()
  (io:format &quot;~nYou have already welded the bucket and chain!~n&quot;))
</code></pre>
<p>Notice that our <code>good-weld</code> function takes the game state as a parameter, unlike the other functions. This is us planning for the future :-) We may want to do something with the game state <em>after</em> we check for a good weld ...</p>
<p>And now for the welding!</p>
<pre><code class="language-lisp">(defun weld-them
  (('chain 'bucket game-state)
    (let ((ready? (weld-ready? game-state)))
      (cond ((goal-met? 'weld-chain game-state)
              (already-welded)
              game-state)
            ((not ready?)
              (weld-not-ready)
              game-state)
            (ready?
              (good-weld
                (update-goals 'weld-chain game-state))))))
  ((_ _ game-state)
    (cant-weld)
    game-state))
</code></pre>
<p>All of the code above should be familiar to you now, and with that, we've pieced together all our various functions to give our game a new action.</p>
<p><img src="../images/weld.jpg" alt="" /></p>
<p>Let's try our new command:</p>
<pre><code class="language-lisp">&gt; (weld-them 'chain 'bucket state)
</code></pre>
<pre><code class="language-lisp">You seem to be missing a key condition for welding ...
</code></pre>
<p>Oops... we're don't have a bucket or chain, do we? ...and there's no welding machine around... oh well...</p>
<p>Now let's create a command for dunking the chain and bucket in the well. We'll need similar functions for this action:</p>
<pre><code class="language-lisp">(defun dunk-ready? (game-state)
  (andalso (inv? 'bucket game-state)
           (goal-met? 'weld-chain game-state)
           (== (state-player-location game-state) 'garden)))

(defun dunk-not-ready ()
  (io:format &quot;~nYou seem to be missing a key condition for dunking ...~n&quot;))

(defun cant-dunk ()
  (io:format &quot;~nYou can't dunk like that ...~n&quot;))

(defun good-dunk (game-state)
  (io:format &quot;~nThe bucket is now full of water.~n&quot;)
  game-state)

(defun already-dunked ()
  (io:format &quot;~nYou filled the bucket. Again.~n&quot;))

(defun dunk-it
  (('bucket 'well game-state)
    (let ((ready? (dunk-ready? game-state)))
      (cond ((goal-met? 'dunk-bucket game-state)
              (already-dunked)
              game-state)
            ((not ready?)
              (dunk-not-ready)
              game-state)
            (ready?
              (good-dunk
                (update-goals 'dunk-bucket game-state))))))
  ((_ _ game-state)
    (cant-dunk)
    game-state))
</code></pre>
<p>Hrm ... what can we do about that repetitive code?</p>

                </main>

                <nav class="nav-wrapper" aria-label="Page navigation">
                    <!-- Mobile navigation buttons -->
                    
                    <a rel="prev" href="../part6/3-interact.html" class="mobile-nav-chapters previous"
                        title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    

                    
                    <a rel="next" href="../part6/5-spacts.html" class="mobile-nav-chapters next"
                        title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                    

                    <div style="clear: both"></div>
                </nav>
            </div>
        </div>

        <nav class="nav-wide-wrapper" aria-label="Page navigation">
            
            <a rel="prev" href="../part6/3-interact.html" class="nav-chapters previous" title="Previous chapter"
                aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>
            

            
            <a rel="next" href="../part6/5-spacts.html" class="nav-chapters next" title="Next chapter"
                aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
            
        </nav>

    </div>

    
    <!-- Livereload script (if served using the cli tool) -->
    <script type="text/javascript">
        var socket = new WebSocket("ws://localhost:3000/__livereload");
        socket.onmessage = function (event) {
            if (event.data === "reload") {
                socket.close();
                location.reload();
            }
        };

        window.onbeforeunload = function () {
            socket.close();
        }
    </script>
    

    
    <!-- Google Analytics Tag -->
    <script type="text/javascript">
        var localAddrs = ["localhost", "127.0.0.1", ""];

        // make sure we don't activate google analytics if the developer is
        // inspecting the book locally...
        if (localAddrs.indexOf(document.location.hostname) === -1) {
            (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-38274766-4', 'auto');
            ga('send', 'pageview');
        }
    </script>
    

    

    
    <script type="text/javascript">
        window.playground_copyable = true;
    </script>
    

    

    
    <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
    

    <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
    <script src="../book.js" type="text/javascript" charset="utf-8"></script>

    <!-- Custom JS scripts -->
    

    

</body>

</html>
