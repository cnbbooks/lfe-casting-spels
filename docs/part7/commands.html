<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js lfe-pdp">

<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>Supporting Commands - Casting SPELs in LFE</title>
    
    


    <!-- Custom HTML head -->
    


    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="The LFE Edition of the Classic Lisp Comic Book">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff" />

    <link rel="icon" href="../favicon.svg">
    <link rel="shortcut icon" href="../favicon.png">
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/general.css">
    <link rel="stylesheet" href="../css/chrome.css">
    <link rel="stylesheet" href="../css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
    
    <link rel="stylesheet" href="../fonts/fonts.css">
    

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="../highlight.css">
    <link rel="stylesheet" href="../tomorrow-night.css">
    <link rel="stylesheet" href="../ayu-highlight.css">

    <!-- Custom theme stylesheets -->
    
    <link rel="stylesheet" href="../css/custom.css">
    

    
</head>

<body>
    <!-- Provide site root to javascript -->
    <script type="text/javascript">
        var path_to_root = "../";
        var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "lfe-pdp" : "lfe-pdp";
    </script>

    <!-- Work around some values being stored in localStorage wrapped in quotes -->
    <script type="text/javascript">
        try {
            var theme = localStorage.getItem('mdbook-theme');
            var sidebar = localStorage.getItem('mdbook-sidebar');

            if (theme.startsWith('"') && theme.endsWith('"')) {
                localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
            }

            if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
            }
        } catch (e) { }
    </script>

    <!-- Set the theme before any content is loaded, prevents flash -->
    <script type="text/javascript">
        var theme;
        try { theme = localStorage.getItem('mdbook-theme'); } catch (e) { }
        if (theme === null || theme === undefined) { theme = default_theme; }
        var html = document.querySelector('html');
        html.classList.remove('no-js')
        html.classList.remove('lfe-pdp')
        html.classList.add(theme);
        html.classList.add('js');
    </script>

    <!-- Hide / unhide sidebar before it is displayed -->
    <script type="text/javascript">
        var html = document.querySelector('html');
        var sidebar = 'hidden';
        if (document.body.clientWidth >= 1080) {
            try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch (e) { }
            sidebar = sidebar || 'visible';
        }
        html.classList.remove('sidebar-visible');
        html.classList.add("sidebar-" + sidebar);
    </script>

    <nav id="sidebar" class="sidebar" aria-label="Table of contents">
        <div class="sidebar-scrollbox">
            <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Casting SPELs in LFE</a></li><li class="chapter-item expanded "><a href="../front-matter/copyright-page.html"><strong aria-hidden="true">2.</strong> Copyright Page</a></li><li class="chapter-item expanded "><a href="../introduction/index.html"><strong aria-hidden="true">3.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../introduction/whatslfe.html"><strong aria-hidden="true">3.1.</strong> What is LFE?</a></li><li class="chapter-item expanded "><a href="../introduction/spels.html"><strong aria-hidden="true">3.2.</strong> Casting SPELs in LFE?</a></li><li class="chapter-item expanded "><a href="../introduction/about.html"><strong aria-hidden="true">3.3.</strong> About the Text</a></li><li class="chapter-item expanded "><a href="../introduction/contributing.html"><strong aria-hidden="true">3.4.</strong> Contributing</a></li></ol></li><li class="chapter-item expanded "><a href="../part1/index.html"><strong aria-hidden="true">4.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part1/prerequisites.html"><strong aria-hidden="true">4.1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="../part1/project.html"><strong aria-hidden="true">4.2.</strong> Project Space</a></li><li class="chapter-item expanded "><a href="../part1/repl.html"><strong aria-hidden="true">4.3.</strong> The REPL</a></li><li class="chapter-item expanded "><a href="../part1/syn-sem.html"><strong aria-hidden="true">4.4.</strong> Syntax &amp; Semantics</a></li></ol></li><li class="chapter-item expanded "><a href="../part2/index.html"><strong aria-hidden="true">5.</strong> Introducing the Game</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part2/objects.html"><strong aria-hidden="true">5.1.</strong> Objects</a></li><li class="chapter-item expanded "><a href="../part2/locations.html"><strong aria-hidden="true">5.2.</strong> Locations</a></li><li class="chapter-item expanded "><a href="../part2/funcs.html"><strong aria-hidden="true">5.3.</strong> Introducing Functions</a></li></ol></li><li class="chapter-item expanded "><a href="../part3/index.html"><strong aria-hidden="true">6.</strong> Getting Functional</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part3/glob.html"><strong aria-hidden="true">6.1.</strong> Global State</a></li><li class="chapter-item expanded "><a href="../part3/nonglob.html"><strong aria-hidden="true">6.2.</strong> A Non-global Alternative</a></li><li class="chapter-item expanded "><a href="../part3/fp.html"><strong aria-hidden="true">6.3.</strong> The Functional Programming Style</a></li></ol></li><li class="chapter-item expanded "><a href="../part4/index.html"><strong aria-hidden="true">7.</strong> Game World Data</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part4/records/index.html"><strong aria-hidden="true">7.1.</strong> Organizing with Records</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part4/records/game.html"><strong aria-hidden="true">7.1.1.</strong> Game State</a></li><li class="chapter-item expanded "><a href="../part4/records/objects.html"><strong aria-hidden="true">7.1.2.</strong> Objects</a></li><li class="chapter-item expanded "><a href="../part4/records/places-exits.html"><strong aria-hidden="true">7.1.3.</strong> Places &amp; Exits</a></li><li class="chapter-item expanded "><a href="../part4/records/rooms.html"><strong aria-hidden="true">7.1.4.</strong> Rooms</a></li><li class="chapter-item expanded "><a href="../part4/records/goals.html"><strong aria-hidden="true">7.1.5.</strong> Goals</a></li><li class="chapter-item expanded "><a href="../part4/records/thatsalot.html"><strong aria-hidden="true">7.1.6.</strong> That's a LOT!</a></li></ol></li><li class="chapter-item expanded "><a href="../part4/map.html"><strong aria-hidden="true">7.2.</strong> Making the World Map</a></li><li class="chapter-item expanded "><a href="../part4/recfuncs.html"><strong aria-hidden="true">7.3.</strong> Records Functions</a></li></ol></li><li class="chapter-item expanded "><a href="../part5/index.html"><strong aria-hidden="true">8.</strong> Looking Around in our Game World</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part5/location.html"><strong aria-hidden="true">8.1.</strong> Location, Location, Location</a></li><li class="chapter-item expanded "><a href="../part5/patts.html"><strong aria-hidden="true">8.2.</strong> Thinking in Patterns</a></li><li class="chapter-item expanded "><a href="../part5/exits.html"><strong aria-hidden="true">8.3.</strong> Exits</a></li><li class="chapter-item expanded "><a href="../part5/finding.html"><strong aria-hidden="true">8.4.</strong> Finding Things</a></li><li class="chapter-item expanded "><a href="../part5/looking.html"><strong aria-hidden="true">8.5.</strong> Putting These Pieces Together</a></li></ol></li><li class="chapter-item expanded "><a href="../part6/index.html"><strong aria-hidden="true">9.</strong> Casting SPELs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part6/walking.html"><strong aria-hidden="true">9.1.</strong> Walking Around</a></li><li class="chapter-item expanded "><a href="../part6/spels.html"><strong aria-hidden="true">9.2.</strong> Introducing SPELs</a></li><li class="chapter-item expanded "><a href="../part6/interact.html"><strong aria-hidden="true">9.3.</strong> Interacting</a></li><li class="chapter-item expanded "><a href="../part6/cmplx.html"><strong aria-hidden="true">9.4.</strong> Complex Interactions</a></li><li class="chapter-item expanded "><a href="../part6/spacts.html"><strong aria-hidden="true">9.5.</strong> Creating Special Actions</a></li><li class="chapter-item expanded "><a href="../part6/winact.html"><strong aria-hidden="true">9.6.</strong> The Winning Move</a></li></ol></li><li class="chapter-item expanded "><a href="../part7/index.html"><strong aria-hidden="true">10.</strong> Adding a Simple Game Server</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part7/state.html"><strong aria-hidden="true">10.1.</strong> The Problem of State</a></li><li class="chapter-item expanded "><a href="../part7/closures.html"><strong aria-hidden="true">10.2.</strong> A Glance at Closures</a></li><li class="chapter-item expanded "><a href="../part7/processes.html"><strong aria-hidden="true">10.3.</strong> Light-weight Processes as Closures</a></li><li class="chapter-item expanded "><a href="../part7/server.html"><strong aria-hidden="true">10.4.</strong> Making a Game Server</a></li><li class="chapter-item expanded "><a href="../part7/commands.html" class="active"><strong aria-hidden="true">10.5.</strong> Supporting Commands</a></li></ol></li><li class="chapter-item expanded "><a href="../part8/index.html"><strong aria-hidden="true">11.</strong> Let's Play!</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../part8/win.html"><strong aria-hidden="true">11.1.</strong> Playing to Win</a></li><li class="chapter-item expanded "><a href="../part8/lose.html"><strong aria-hidden="true">11.2.</strong> Playing to Lose</a></li><li class="chapter-item expanded "><a href="../part8/next.html"><strong aria-hidden="true">11.3.</strong> What's Next?</a></li></ol></li><li class="chapter-item expanded "><a href="../addenda/index.html"><strong aria-hidden="true">12.</strong> Addenda</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../addenda/changes.html"><strong aria-hidden="true">12.1.</strong> Changes from the Original</a></li><li class="chapter-item expanded "><a href="../addenda/whyspels.html"><strong aria-hidden="true">12.2.</strong> The Case Against the Word &quot;Macro&quot;</a></li><li class="chapter-item expanded "><a href="../addenda/escript.html"><strong aria-hidden="true">12.3.</strong> An Executable</a></li><li class="chapter-item expanded "><a href="../addenda/otp.html"><strong aria-hidden="true">12.4.</strong> Using OTP</a></li><li class="chapter-item expanded "><a href="../addenda/source.html"><strong aria-hidden="true">12.5.</strong> Source Code</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../feedback.html">Feedback</a></li><li class="chapter-item expanded affix "><a href="../redirects/docs.html">LFE Documentation</a></li><li class="chapter-item expanded affix "><a href="../redirects/mdbook.html">Built with mdBook</a></li></ol>
        </div>
        <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
    </nav>

    <div id="page-wrapper" class="page-wrapper">

        <div class="page">
            
            <div id="menu-bar-hover-placeholder"></div>
            <div id="menu-bar" class="menu-bar sticky bordered">
                <div class="left-buttons">
                    <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                        <i class="fa fa-bars"></i>
                    </button>
                    <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                        <i class="fa fa-paint-brush"></i>
                    </button>
                    <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                        <li role="none"><button role="menuitem" class="theme"
                                id="lfe-pdp">LFE PDP</button></li>
                        <li role="none"><button role="menuitem" class="theme"
                                id="light">Light</button></li>
                        <li role="none"><button role="menuitem" class="theme"
                                id="rust">Rust</button></li>
                        <li role="none"><button role="menuitem" class="theme"
                                id="coal">Coal</button></li>
                        <li role="none"><button role="menuitem" class="theme"
                                id="navy">Navy</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button>
                        </li>
                    </ul>
                    
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                        aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                        aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
                    
                </div>

                <h1 class="menu-title">Casting SPELs in LFE</h1>

                <div class="right-buttons">
                    <a href="../print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    
                    <a href="https://github.com/lfe/casting-spels/" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-github"></i>
                    </a>
                    
                </div>
            </div>

            
            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                        placeholder="Search this book ..." aria-controls="searchresults-outer"
                        aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>
            

            <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
            <script type="text/javascript">
                document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                    link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                });
            </script>

            <div id="content" class="content">
                <main>
                    <h1><a class="header" href="#supporting-commands" id="supporting-commands">Supporting Commands</a></h1>
<p>Throughout the entirety of this little book, we've asked you, gentle coder, to suspend the horror of having to see the game state spit out at you with every command. At the beginning of this chapter, we proposed a solution for this -- the use of closures -- in order to hide the state data from the user experience. In the last section we successfully created a game server that will contain this state. That last piece of this puzzle, then, is now able to fall into place: a new set of game commands, specifically written to make use of our new game server.</p>
<p>We can also take this opportunity to do a little clean-up work on the command results. We will tackle the following</p>
<ul>
<li>Create a new command prompt that provides a separator between our last action + result and the new user prompt;</li>
<li>Create a SPEL for sending a command to the server;</li>
<li>Create command SPELs that make use of this general <code>send</code> SPEL; and</li>
<li>Create a function that presents text to the user in a nicely-wrapped manner.</li>
</ul>
<p>Let's finish up!</p>
<p>As just mentioned, we're going to want to put a separator between each command:</p>
<pre><code class="language-lisp">(defspel sent-prompt ()
  '(list_to_atom (string:copies &quot;-&quot; 78)))
</code></pre>
<p>Not only does that help us keep the command history clearly delineated, it takes care of that pesky problem of seeing the return value from calling the <code>(! ...)</code> function.</p>
<p>Speaking of which: since we're going to be making so many calls to <code>(! ...)</code> (one for each command), how about we create a SPEL for that -- it will make things much cleaner:</p>
<pre><code class="language-lisp">(defspel send (args)
  `(progn
    (! (whereis 'game-server) ,args)
    ',(sent-prompt)))
</code></pre>
<p>We had noticed earlier when making our first process-based server that the command <code>hi</code> was output to the user -- this is simply because it was the output of the last function inside the <code>send</code> command. What if we make the last function inside the <code>send</code> command return something that we <em>want</em> to see? ... like our new prompt! So that's what we've done :-)</p>
<p>Now let's create the commands that we will type: the SPELs that will send messages to our little game server:</p>
<pre><code class="language-lisp">(defspel go (direction)
  `(send #(go ,direction)))

(defspel look ()
  `(send #(look)))

(defspel exits ()
  `(send #(exits)))

(defspel inv ()
  `(send #(inv)))

(defspel take (item)
  `(send #(take ,item)))

(defspel weld (subj obj)
  `(send #(weld ,subj ,obj)))

(defspel dunk (subj obj)
  `(send #(dunk ,subj ,obj)))

(defspel splash (subj obj)
  `(send #(splash ,subj ,obj)))
</code></pre>
<p>Now that we've got some new SPELs, let's try them out:</p>
<pre><code class="language-lisp">lfe&gt; (look)
------------------------------------------------------------------------------
lfe&gt;
You are in the living-room of a wizard's house. There is a wizard snoring loudly on the couch.
You see a whiskey-bottle on the ground. You see a bucket on the ground.
There is a door going west from here. There is a stairway going upstairs from here.
</code></pre>
<p>Look at that! No more state -- we're not passing it and we're not seeing it returned! The closures are taking care of that for us. We haven't abandoned the <em>functional programming way</em> -- our game code is still not mutating any data. We've just &quot;hidden&quot; the plumbing, as it were, with the raised floor of closures :-)</p>
<p>But ... the lines are a bit long. Let's make some changes to fix that. Here's
some code for wrapping long lines:</p>
<pre><code class="language-lisp">(defun make-regex-str (max-len)
  (++ &quot;(.{1,&quot; (integer_to_list max-len) &quot;}|\\S{&quot;
      (integer_to_list (+ max-len 1)) &quot;,})(?:\\s[^\\S\\r\\n]*|\\Z)&quot;))

(defun wrap-text (text max-len)
  (let ((find-patt (make-regex-str max-len))
        (replace-patt &quot;\\1\\\n&quot;))
    (re:replace text find-patt replace-patt
                '(global #(return list)))))

(defun wrap-text (text)
  (wrap-text text 78))
</code></pre>
<p>And we can use that to update our <code>display-scene/1</code> and <code>display-exits/1</code> functions:</p>
<pre><code class="language-lisp">(defun display-scene (game-state)
  (io:format
    &quot;~n~s~s~s&quot;
    (lists:map
      #'wrap-text/1
      `(,(describe-location game-state)
        ,(describe-items game-state)
        ,(describe-exits game-state)))))

(defun display-exits (game-state)
  (io:format
    &quot;~n~s&quot;
    (list (wrap-text (describe-exits game-state)))))
</code></pre>
<p>Let's try again, with our display functions updated to wrap long text:</p>
<pre><code>lfe&gt; (stop)
#(status game-over)
lfe&gt; (start)
#(status started)
lfe&gt; (look)
------------------------------------------------------------------------------
lfe&gt;
You are in the living-room of a wizard's house. There is a wizard snoring
loudly on the couch.
You see a whiskey-bottle on the ground. You see a bucket on the ground.
There is a door going west from here. There is a stairway going upstairs from
here.
</code></pre>
<p>Ah, much better :-)</p>
<p>Well, it looks like we're finally ready to play our game!</p>

                </main>

                <nav class="nav-wrapper" aria-label="Page navigation">
                    <!-- Mobile navigation buttons -->
                    
                    <a rel="prev" href="../part7/server.html" class="mobile-nav-chapters previous"
                        title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    

                    
                    <a rel="next" href="../part8/index.html" class="mobile-nav-chapters next"
                        title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                    

                    <div style="clear: both"></div>
                </nav>
            </div>
        </div>

        <nav class="nav-wide-wrapper" aria-label="Page navigation">
            
            <a rel="prev" href="../part7/server.html" class="nav-chapters previous" title="Previous chapter"
                aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>
            

            
            <a rel="next" href="../part8/index.html" class="nav-chapters next" title="Next chapter"
                aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
            
        </nav>

    </div>

    
    <!-- Livereload script (if served using the cli tool) -->
    <script type="text/javascript">
        var socket = new WebSocket("ws://localhost:3000/__livereload");
        socket.onmessage = function (event) {
            if (event.data === "reload") {
                socket.close();
                location.reload();
            }
        };

        window.onbeforeunload = function () {
            socket.close();
        }
    </script>
    

    
    <!-- Google Analytics Tag -->
    <script type="text/javascript">
        var localAddrs = ["localhost", "127.0.0.1", ""];

        // make sure we don't activate google analytics if the developer is
        // inspecting the book locally...
        if (localAddrs.indexOf(document.location.hostname) === -1) {
            (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-38274766-4', 'auto');
            ga('send', 'pageview');
        }
    </script>
    

    

    
    <script type="text/javascript">
        window.playground_copyable = true;
    </script>
    

    

    
    <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
    

    <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
    <script src="../book.js" type="text/javascript" charset="utf-8"></script>

    <!-- Custom JS scripts -->
    

    

</body>

</html>
